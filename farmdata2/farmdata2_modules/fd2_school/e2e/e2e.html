<html>
    <h1 data-cy="page-header">Harvest Report</h1>
    <p>This page is a <em>mockup</em> of a simplified harvest report.</p>

    <div id="harvest-report" v-cloak>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" v-model="rptTitle">

        <br><br>
        
        <label for="start">Start:</label>
        <input data-cy="start-date" type="date" id="start" :min="2014-01-01" :max="rptEnd" v-model="rptStart">

        <label for="end">End:</label>
        <input data-cy="end-date" type="date" id="end" :min="rptStart" :max="2022-01-01" v-model="rptEnd">

        <br><br>
        
        <label for="crop">Crop:</label>
        <select data-cy="crop-names" id="crop" name="crop" v-model="rptCrop">
            <option v-for="crop in cropNames">{{crop}}</option>
        </select>

        <label for="area">Area:</label>
        <select data-cy="area-names" id="area" name="area" v-model="rptArea">
            <option v-for="area in areaNames">{{area}}</option>
        </select>

        <br><br>
        
        <button data-cy="generate-report" type="submit" @click=" () =>{
            generateReport();
            let startTimestamp = dayjs(this.rptStart).unix();
            let endTimestamp = dayjs(this.rptEnd).unix();
            console.log('Start date:', startTimestamp);
            console.log('End date:', endTimestamp);
                    
            let requestUrl = `/log.json?type=farm_harvest&timestamp[ge]=${startTimestamp}&timestamp[le]=${endTimestamp}`;
            console.log(requestUrl);

            getAllPages(requestUrl).then((result) => {
                this.rptHarvestLogs=result;
                console.log('got the pages');
                }).catch((err) => {
                    console.log('failed to get the pages');
                })
        }
        ">Generate Report </button>

        <hr>

        <div v-if="harvestReportRows.length > 0">
            <h1 data-cy="table-header">{{rptTitle ? rptTitle : "Mock Harvest Report"}}</h1>  

            <p>Details</p>
            <ul>
                <li> <strong>Farm:</strong>{{farm}} </li>
                <li> <strong>User:</strong>{{user}} </li>
                 <li> <strong>Language:</strong>{{language}} </li>
            </ul>

             <ul>
                <li> <strong>Start:</strong>{{rptStart}} </li>
                <li> <strong>End:</strong>{{rptEnd}} </li>
                <li> <strong>Crop:</strong>{{rptCrop}} </li>
            </ul>

            <table border="1">
                <tr>
                    <th>Row</th>
                    <th>Date</th>
                    <th>Area</th>
                    <th>Crop</th>
                    <th>Yield</th>
                    <th>Units</th>
                </tr>
                <tr v-for="(log, index) in harvestReportRows" :key="index">
                    <td>{{index+1}}</td>
                    <td>{{log.date}}</td>
                    <td>{{log.area}}</td>
                    <td>{{log.crop}}</td>
                    <td>{{log.yield}}</td>
                    <td>{{log.unit}}</td>
                </tr>
            </table>
        </div>
        <p v-else> No Matching Records</p>

    </div>

    <script>
        var harvestReport = new Vue({
            el:"#harvest-report",
            created() {
                getIDToCropMap().then((theMap) => {
                    this.idToCropMap= theMap;
                    console.log("got the idToCropMap");

                    // Set the default crop to the first value
                    const cropValues = Array.from(this.idToCropMap.values());
                    if (cropValues.length > 0) {
                        this.rptCrop = cropValues[0];
                        console.log("Default crop set to:", this.rptCrop);
                    }

                }).catch((err) => {
                    console.log("failed to get the idToCropMap");
                });

                getIDToAreaMap().then((theMap) =>{
                    this.idToAreaMap= theMap;
                    console.log("got the idToAreaMap");

                    // Set the default area to the first value
                    const areaValues = Array.from(this.idToAreaMap.values());
                    if (areaValues.length > 0) {
                        this.rptArea = areaValues[0];
                        console.log("Default crop set to:", this.rptArea);
                    }

                }).catch((err) => {
                    console.log("failed to get the idToAreaMap");
                });

            },
            computed:{
                cropNames(){
                    return Array.from(this.idToCropMap.values());
                },
                areaNames(){
                    return Array.from(this.idToAreaMap.values());
                },
                harvestReportRows() {
	                let tableRows = []
	                for(let log of this.rptHarvestLogs) {
		                let tableRow = {
			            date: dayjs.unix(log.timestamp).format("YYYY-MM-DD"),
                        area: log.area[0].name,
                        crop: this.idToCropMap.get(log.data.crop_tid),
                        yield: log.quantity[0].value,
                        unit: log.quantity[0].unit.name,
		                }
                        if (tableRow.crop == this.rptCrop) {
                            tableRows.push(tableRow);
                        }
	                }
	                return tableRows
                },
            },
            data:{
                farm:"",
                user:"",
                language:"",
                rptTitle:"My Sample Harvest Report",
                rptStart:"2020-05-05",
                rptEnd:"2020-05-15",
                rptCrop:"",
                rptArea:"",
                rptCropList: [ "Broccoli", "kale", "Peas"],
                rptAreaList: [ "all", "Chuau-1", "SQ7"],
                rptHarvestLogs: [],
                idToCropMap: new Map(),
                idToAreaMap: new Map(),
            },
            methods:{
                generateReport: function(){

                    axios.get("/farm.json").then((response) => {
                            console.log("Got Response")
                            console.log(response)
                        })
                        .catch((error) => {
                            console.log("Error Occurred")
                            console.log(error)
                        })

                     this.farm="Sample Farm",
                     this.user="manager1"
                     this.language="English"
                },
            },
        });
        Vue.config.devtools = true;
    </script>

</html>